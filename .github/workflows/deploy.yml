# This workflow deploys your plugin to WordPress.org
# It now includes a step to VALIDATE the version number.

name: 'Deploy to WordPress SVN'

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checks out a copy of your repository
      - name: 'Checkout'
        uses: actions/checkout@v4

      # 2. NEW: Validate Readme and Release Tag
      # This step compares the GitHub release tag with the 'Stable tag' in readme.txt
      - name: 'Validate Readme and Release Tag'
        run: |
          # Get the version from the GitHub release tag (e.g., 'v1.2.3' or '1.2.3')
          # The 'github.ref_name' variable holds the tag name
          GITHUB_TAG_VERSION="${{ github.ref_name }}"
          
          # Strip the 'v' prefix if it exists (e.g., 'v1.2.3' -> '1.2.3')
          RELEASE_VERSION=${GITHUB_TAG_VERSION#v}
          
          # Get the 'Stable tag' from readme.txt
          # It finds the line 'Stable tag: 1.2.3' and extracts '1.2.3'
          README_VERSION=$(grep -i "Stable tag:" readme.txt | awk -F' ' '{print $3}' | tr -d '\r')
          
          # Print the versions for debugging
          echo "Release Tag: $RELEASE_VERSION"
          echo "Readme Version: $README_VERSION"
          
          # Compare the versions
          if [ "$RELEASE_VERSION" != "$README_VERSION" ]; then
            echo "Error: Release tag ($RELEASE_VERSION) does not match readme.txt Stable tag ($README_VERSION)."
            exit 1 # Fails the workflow
          fi

      # 3. This step only runs if the validation step above passed
      - name: 'WordPress Plugin Deploy'
        uses: 10up/action-wordpress-plugin-deploy@stable
        with:
          # Your plugin's slug on WordPress.org
          plugin_slug: 'ziosync-connection-rest-api'
          
          # Optional: Path to a directory of assets
          # assets_dir: '.wordpress-org'
          
        env:
          # Use the secrets you created
          SVN_USERNAME: ${{ secrets.WORDPRESS_SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.WORDPRESS_SVN_PASSWORD }}
