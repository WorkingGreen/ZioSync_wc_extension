# This workflow deploys your plugin to WordPress.org
# It now includes a step to VALIDATE all 3 version numbers.

name: 'Deploy to WordPress SVN'

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checks out a copy of your repository
      - name: 'Checkout'
        uses: actions/checkout@v4

      # 2. NEW: Validate Versions (Tag, Readme, and Plugin File)
      # This step compares the GitHub release tag, 'Stable tag' in readme.txt,
      # and 'Version:' in the main plugin file.
      - name: 'Validate Versions'
        run: |
          PLUGIN_DIR="ziosync-connection-rest-api"
          MAIN_PLUGIN_FILE="$PLUGIN_DIR/ziosync-connection-rest-api.php"
          MAIN_README_FILE="$PLUGIN_DIR/readme.txt"

          # 1. Get version from GitHub release tag (e.g., 'v1.2.3' -> '1.2.3')
          GITHUB_TAG_VERSION="${{ github.ref_name }}"
          RELEASE_VERSION=${GITHUB_TAG_VERSION#v}
          
          # 2. Get 'Stable tag' from readme.txt
          # Splits at the colon and trims whitespace
          README_VERSION=$(grep -i "Stable tag:" $MAIN_README_FILE | awk -F':' '{print $2}' | xargs)
          
          # 3. Get 'Version:' from main plugin file header
          # Finds the first line starting with ' * Version:' or 'Version:',
          # splits at the colon, and trims whitespace.
          PLUGIN_FILE_VERSION=$(grep -i -P "\*\s*Version:" $MAIN_PLUGIN_FILE | head -n 1 | awk -F':' '{print $2}' | xargs)
          
          # Print all versions for debugging
          echo "Release Tag:         $RELEASE_VERSION"
          echo "Readme 'Stable tag':   $README_VERSION"
          echo "Plugin file 'Version:': $PLUGIN_FILE_VERSION"
          
          # 4. Check if any versions are empty (which means parsing failed)
          if [ -z "$RELEASE_VERSION" ]; then
            echo "Error: Could not find Release Tag version."
            exit 1
          elif [ -z "$README_VERSION" ]; then
            echo "Error: Could not find 'Stable tag' in readme.txt."
            exit 1
          elif [ -z "$PLUGIN_FILE_VERSION" ]; then
            echo "Error: Could not find 'Version:' in $MAIN_PLUGIN_FILE."
            echo "Please check that the MAIN_PLUGIN_FILE variable is set correctly in the workflow."
            exit 1
          fi

          # 5. Compare all three versions
          if [ "$RELEASE_VERSION" != "$README_VERSION" ]; then
            echo "Error: Release tag ($RELEASE_VERSION) does not match readme.txt 'Stable tag' ($README_VERSION)."
            exit 1 
          elif [ "$RELEASE_VERSION" != "$PLUGIN_FILE_VERSION" ]; then
            echo "Error: Release tag ($RELEASE_VERSION) does not match plugin file 'Version:' ($PLUGIN_FILE_VERSION)."
            exit 1 
          fi

          echo "All three versions match! Proceeding with deployment."

      # 3. This step only runs if the validation step above passed
      - name: 'WordPress Plugin Deploy'
        uses: 10up/action-wordpress-plugin-deploy@stable
        env:
          # Use the secrets you created
          SVN_USERNAME: ${{ secrets.WORDPRESS_SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.WORDPRESS_SVN_PASSWORD }}
          SLUG: ziosync-connection-rest-api
          BUILD_DIR: ziosync-connection-rest-api
          ASSETS_DIR: wordpress_assets
